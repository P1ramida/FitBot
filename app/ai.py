import os
from dotenv import load_dotenv
from openai import AsyncClient

load_dotenv(override=True)

client = AsyncClient(
    base_url="https://openrouter.ai/api/v1",
    api_key=os.getenv("AI_TOKEN"),
)


async def photo_recognition( * , file_url: str, task_name: str, task_description: str, goal: str = None) -> str:
    try:
        text_prompt = f"""
–¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–Ω–æ –∑–∞–¥–∞–Ω–∏—é.

–ó–ê–î–ê–ù–ò–ï: {task_name}
–û–ü–ò–°–ê–ù–ò–ï –ó–ê–î–ê–ù–ò–Ø: {task_description}

–ü—Ä–∞–≤–∏–ª–∞:
1. –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–¥–∞–Ω–∏—é, –Ω–∞–ø—Ä–∏–º–µ—Ä:
   - –ó–∞–¥–∞–Ω–∏–µ ‚Äî —Ñ–æ—Ç–æ –µ–¥—ã, –∞ –Ω–∞ —Ñ–æ—Ç–æ –º–∞—à–∏–Ω–∞ –∏–ª–∏ —á—Ç–æ-—Ç–æ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –Ω–µ —Å–≤—è–∑–∞–Ω–Ω–æ–µ —Å –µ–¥–æ–π.
   - –ó–∞–¥–∞–Ω–∏–µ ‚Äî —Ñ–æ—Ç–æ —à–∞–≥–æ–º–µ—Ä–∞, –∞ –Ω–∞ —Ñ–æ—Ç–æ –ø—Ä–µ–¥–º–µ—Ç, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å —à–∞–≥–æ–º–µ—Ä–æ–º.
   –í —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö –≤–µ—Ä–Ω–∏ —Å—Ç—Ä–æ–≥–æ "False" (—Å—Ç—Ä–æ–∫–æ–π).

2. –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω–æ —Å –∑–∞–¥–∞–Ω–∏–µ–º, –Ω–æ –Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–æ—Ç–æ –∂–∏—Ä–Ω–æ–π –µ–¥—ã –≤–º–µ—Å—Ç–æ –∑–∞–≤—Ç—Ä–∞–∫–∞), 
   —Ç–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–π "False", –∞ –¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —É—á–∏—Ç—ã–≤–∞—è —Ü–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   ({goal or "—Ü–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}).
   –î–æ–±–∞–≤—å –≤ –æ—Ç–≤–µ—Ç –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–µ —Å–º–∞–π–ª–∏–∫–∏ üòäüëç –∏, –µ—Å–ª–∏ —Ä–µ—á—å –∏–¥—ë—Ç –æ –µ–¥–µ, –ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ–¥—Å—á–∏—Ç–∞–π –∏ —É–∫–∞–∂–∏ –ö–ë–ñ–£ (–∫–∞–ª–æ—Ä–∏–∏, –±–µ–ª–∫–∏, –∂–∏—Ä—ã, —É–≥–ª–µ–≤–æ–¥—ã).

3. –ï—Å–ª–∏ –∑–∞–¥–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ü–∏—Ñ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–æ—Ç–æ —à–∞–≥–æ–º–µ—Ä–∞ –∏–ª–∏ –≤–µ—Å–æ–≤), –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∏—Ç,
   —Ç–æ –ø–æ–ø—ã—Ç–∞–π—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ü–∏—Ñ—Ä—ã –∏ –¥–∞—Ç—å –æ—Ü–µ–Ω–∫—É –ø–æ –∑–∞–¥–∞–Ω–∏—é –∏ –æ–ø–∏—Å–∞–Ω–∏—é, –¥–æ–±–∞–≤—å —ç–º–æ–¥–∑–∏ –¥–ª—è –±–æ–ª—å—à–µ–π –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏.

4. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π "False", –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–ª–∏–∑–∫–æ –ø–æ —Ç–µ–º–∞—Ç–∏–∫–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ. "False" ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è.

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
- –õ–∏–±–æ –ø–æ–¥—Ä–æ–±–Ω–æ–π –æ—Ü–µ–Ω–∫–æ–π –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ —Å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º–∏ —Å–º–∞–π–ª–∏–∫–∞–º–∏ –∏ –ø–æ–¥—Å—á—ë—Ç–æ–º –ö–ë–ñ–£, –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ.
- –õ–∏–±–æ —Å—Ç—Ä–æ–∫–æ–π "False" (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫) –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏.

---

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –∑–∞–¥–∞–Ω–∏—é –∏ —Å–ª–µ–¥—É–π —ç—Ç–∏–º –ø—Ä–∞–≤–∏–ª–∞–º.
"""

        completion = await client.chat.completions.create(
            model="google/gemini-2.5-flash-image-preview",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": text_prompt},
                        {"type": "image_url", "image_url": {"url": file_url}},
                    ],
                }
            ],
        )

        return completion.choices[0].message.content.strip()

    except Exception as ex:
        print(f"ERROR: {ex}")
        return "False"

